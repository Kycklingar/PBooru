{{ template "base" .Base}}

{{define "printTags" -}}
{{range . -}}
{{.EditString}}
{{end -}}
{{end}}

{{define "tombhint" -}}
{{.Removed}}
{{.Reason}}
{{end}}

<div id="content">
	<div id="sidebar">
		{{ template "search field" .Sidebar}}
		{{if .Post.Tombstone.Reason}}
		<div class="tombstone" title="{{template "tombhint" .Post.Tombstone}}">RIP</div>
		{{end}}
		{{if .User.ID}}
		<form action="/post/vote/" method="POST">
			<input type="hidden" name="post-id" value="{{.Dupe.Post.ID}}">
			<span>Score:</span>
			<input style="width:auto" type="submit" value="{{.Dupe.Post.Score}}{{if .Voted}}--{{else}}++{{end}}">
		</form>
		{{else}}
		<div>Score: {{.Dupe.Post.Score}}</div>
		<br>
		{{end}}
		{{ template "sidebar tags" .Sidebar}}
		<div class="panel">
			<a href="/spine/post/{{.Post.ID}}/">Post History</a>
			{{if .User.ID}}
			{{if .User.Flag.Tagging}}
			<a href="/post/edit/{{.Post.ID}}/">Edit</a>
			{{end}}
			<details>
				<summary>Other actions</summary>
				<div id="editPostForm">
					{{if .User.Flag.Upload}}
					<form method="POST" action="/post/edit/alts/assign/">
						<span>Assign alt</span>
						<input type="hidden" name="post-id" value="{{.Post.ID}}">
						<input type="number" name="post-id">
						<input type="submit">
					</form>
					<form method="POST" action="/post/edit/alts/split/">
						<span>Remove alt</span>
						<input type="hidden" name="post-id" value="{{.Post.ID}}">
						<input type="hidden" name="ref" value="/post/{{.Post.ID}}/{{.Post.Hash}}/">
						<input type="submit">
					</form>
					{{end}}
					{{if .User.Flag.Delete}}
					<form method="POST" action="/post/edit/thumbnails/generate/">
						<span>Generate Thumbnails</span>
						<input type="hidden" name="post-id" value="{{.Post.ID}}">
						<input type="submit">
					</form>

					<form method="POST" action="/post/edit/remove/">
						<span>Remove Post</span>
						<input type="hidden" name="post-id" value="{{.Post.ID}}">
						<input type="submit" value="{{if .Post.Removed}}Reinstate{{else}}Remove{{end}}">
					</form>
					{{end}}
				</div>
			</details>
			<details>
				<summary>Report</summary>
				<form>
					<span>Compare post with</span>
					<input type="hidden" name="post-id" value="{{.Post.ID}}">
					<input style="padding:0.5em;" type="number" name="post-id">
					<input formaction="/compare2/" type="submit" value="compare2.js">
					<input formaction="/compare/" type="submit" value="compare">
				</form>
				{{template "reportForm" .Post.ID}}
			</details>
			<details id="quickadd" style="display:none">
				<summary>Add to chapter</summary>
				<form style="width:min-content" onsubmit="return incr(this)" method="post" action="/comic/page/add/">
					<br>
					<input type="hidden" name="post-id" value="{{.Post.ID}}">
					<select id="quickadd-chapter" name="chapter-id"></select>
					<input id="quickadd-page" style="margin:2px; padding:3px 0px;" placeholder="Page" type="number" name="order">
					<input type="submit" value="Add to chapter">
				</form>
				<script src="/static/scripts/quickadd.js"></script>
				<script>
					let qac = document.getElementById("quickadd-chapter")
					let det = document.getElementById("quickadd")

					let chapters = qaChapters()

					for(let i = 0; i < chapters.length; i++)
					{
						det.style = "display:inherit"
						let op = document.createElement("option")
						op.value = chapters[i].ID
						op.innerText = chapters[i].comicTitle + " / " + chapters[i].title
						qac.appendChild(op)
						console.log(op)
					}

					if (chapters != null)
					{
						document.getElementById("quickadd-page").value = chapters[0].lastPage
					}

					function incr(form)
					{
						qaIncrement(form["chapter-id"].value, form["order"].value)
					}
				</script>
			</details>
			{{with .User.Pools}}
			<details>
				<summary>Add to pool</summary>
				<form method="POST" action="/user/pools/append/">
					<input type="hidden" name="post-id" value="{{$.Post.ID}}">
					<select style="min-width:100%;" name="pool-id">
						{{range .}}
						<option value="{{.ID}}">{{.Title}}</option>
						{{end}}
					</select>
					<input type="submit" value="Add">
				</form>
			</details>
			{{end}}
			{{end}}
			<details>
				<summary>Find on</summary>
				<div class="box compact">
					<div><a href="https://e621.net/post/show/?md5={{.Post.Checksums.Md5}}">e621.net</a></div>
					<div><a href="https://furry.booru.org/index.php?page=post&s=list&md5={{.Post.Checksums.Md5}}">furry.booru.org</a></div>
					<div><a href="https://rule34.xxx/index.php?page=post&s=list&md5={{.Post.Checksums.Md5}}">rule34.xxx</a></div>
					<div><a href="https://gelbooru.com/index.php?page=post&s=list&md5={{.Post.Checksums.Md5}}">gelbooru.org</a></div>
				</div>
			</details>
			{{with .Post.MetaData.source}}
			<div class="box compact">
				<div class="center">
					Sources
				</div>
				{{range .}}
				<div><a href="{{.Data}}">{{.Data}}</a></div>
				{{end}}
			</div>
			{{end}}
		</div>
	</div>
	<div class="box" id="post">
		{{if eq .Post.Mime.Type "image"}}
		<div id="image">
			<script>
			function resize(caller){
			    if (caller.style.maxWidth == "unset"){
				caller.style.maxWidth = "100%";
			    }else{
				caller.style.maxWidth = "unset";
			    }
			}
			</script>
			<img id="fullsize" onclick="resize(this)" src="{{.UserInfo.Gateway}}/ipfs/{{.Post.Hash}}">
			<b>
				<a href="#fullsize">Fullsize</a>
				<a href="#">Shrink to fit</a>
			</b>
		</div>
		{{else if eq .Post.Mime.Type "video"}}
		<div>
			<video loop controls>
				<source src="{{.UserInfo.Gateway}}/ipfs/{{.Post.Hash}}">
			</video>
		</div>
		{{else}}
		<div>No Preview</div>
		{{end}}
		<details style="float:right">
			<summary>Identity</summary>
			{{template "post-identity" wrap2 "Post" "UserInfo" .Post $.UserInfo}}
		</details>
		<div class="box">
			<a href="{{.UserInfo.Gateway}}/ipfs/{{.Post.Hash}}" download>Download</a>
			<a href="/similar/?id={{.Post.ID}}">Find Similar</a>
			{{with .Post.MetaData.filename}}
			<details>
				<summary>Filenames</summary>
				{{range .}}
				<div><a href="{{$.UserInfo.Gateway}}/ipfs/{{$.Post.Hash}}?filename={{.Data | stripExt}}" download>{{.Data}}</a></div>
				{{end}}
			</details>
			{{end}}
			<div>{{.Post.Mime}}</div>
			<div>{{.Post.SizePretty }}</div>
			{{with .Alts}}
			<div class="cpage-container nolink">
				{{$zindex := 1000}}
				<a href="/posts/1/?alt-group={{$.Dupe.Post.AltGroup}}">
					<div style="z-index:1001;" class="comic-thumb cover">
						Browse all {{len $.Dupe.Post.Alts}} alts
					</div>
				</a>
				{{range .}}
				<div style="z-index:{{$zindex}};" class="comic-thumb" >
					{{$zindex = add $zindex -1}}
					<a href="/post/{{.ID}}/{{.Hash}}">
						<img src="{{$.UserInfo.Gateway}}/ipfs/{{.ClosestThumbnail 256}}" alt="{{.Hash}}">
					</a>
				</div>
				{{end}}
				<br>
			</div>
			{{end}}
			{{range .Dns}}
			{{template "dns-card" wrap2 "UserInfo" "Dns" $.UserInfo .}}
			{{end}}
			{{template "post-description" .Post.Description}}

			{{ if .Post.Removed }}
			<div style="color:#A00; text-shadow:1px 1px #400;">This post has been removed from search results.</div>
			{{else}}
			{{template "post-comments" wrap2 "User" "Comments" $.User .Comments}}
			{{ end }}

		</div>
	</div>
</div>

{{range .Chapters}}
	<div class="box">
		<div>
			<p><a href="/comic/{{.Comic.ID}}/">{{.Comic.Title}}</a></p>
			<p><a href="/comic/{{.Comic.ID}}/{{.Order}}/">C{{.Order}}{{with .Title}} - {{.}}{{end}}</a></p>
			<p>{{.Comic.PageCount}} pages</p>
		</div>
		<div class="cpage-container">
			{{template "chapterPosts" wrap2 "UserInfo" "Posts" $.UserInfo (.PostsLimit 5)}}
		</div>
	</div>
{{end}}

{{with .Dupe}}
	{{if .Inferior}}
	<div class="box">
		<span>Duplicates</span>
		<div class="comic-strip">
		{{template "thumbnail" wrap2 "Post" "UserInfo" .Post $.UserInfo}}
		{{range .Inferior}}
			{{template "thumbnail" wrap2 "Post" "UserInfo" . $.UserInfo}}
		{{end}}
		</div>
	</div>
	{{end}}
{{end}}


{{ template "userSettings" .UserInfo}}

<p>Page generated in {{.Time}}s</p>
{{ template "baseEnd" }}

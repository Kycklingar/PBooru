{{template "base" .Base}}

{{if .User.Flag.Comics}}
<details>
<summary>Create a new chapter</summary>
	<form method="POST" action="/comic/chapter/add/">
	    <input type="hidden" name="comic-id" value="{{.Comic.ID}}">
	    <input placeholder="Title" type="text" name="title">
	    <br>
	    <input placeholder="Order" type="text" name="order">
	    <br>
	    <input type="submit">
	</form>
</details>
{{end}}

<div id="comic-container">
	<h1>{{.Comic.Title}}</h1>
	<form>
		{{if .User.Flag.Comics}}<button type="submit" name="edit-mode">Edit chapters</button>{{end}}
	</form>
	{{$PostLimit := 5}}
	{{if ge (len .Comic.Chapters) 10}}
	{{$PostLimit = 2}}
	{{end}}
	{{range .Comic.Chapters}}
	<div class="comics-container">
		<h3><a href="/comic/{{.Comic.ID}}/{{.Order}}/">Chapter {{.Order}}</a>{{if .Title}} - {{.Title}}{{end}}</h3>
	    	<h4>Pages: {{.PageCount}}</h4>
	    	<div class="cpage-container">
		{{template "chapterPosts" wrap2 "UserInfo" "Posts" $.UserInfo (.PostsLimit $PostLimit)}}
		</div>
		{{if and $.EditMode $.User.Flag.Comics}}
			<details>
			<summary>Edit</summary>
				<form method="post" action="/comic/chapter/edit/">
					<label>Chapter ID: <b>{{.ID}}</b></label>
					<br>
					<input type="hidden" name="chapter-id" value="{{.ID}}">
					<label>Title</label>
					<br>
					<input type="text" name="title" value="{{.Title}}">
					<br>
					<br>
					<label>Order</label>
					<br>
					<input type="number" name="order" value="{{.Order}}">
					<br>
					<br>
					<input type="submit">
				</form>
				<form action="/comic/chapter/delete/" method="POST">
					<input type="hidden" name="chapter-id" value="{{.ID}}">
					<input type="submit" value="Delete">
				</form>
			</details>
		{{end}}
	</div>
	{{end}}
</div>

{{define "chapterPosts"}}
	{{$offset := 0}}
	{{$zindex := 10}}
	{{range .Posts}}
		<div style="position:absolute; left:{{$offset}}em; z-index:{{$zindex}};" class="comic-thumb" >
			{{$offset = add $offset 4}}
			{{$zindex = add $zindex -1}}
        	    	<a href="/post/{{.Post.ID}}/{{.Post.Hash}}">
        	            	<img src="{{$.UserInfo.IpfsDaemon}}/ipfs/{{.Post.ClosestThumbnail 256}}" alt="{{.Post.Hash}}">
        	    	</a>
        	</div>
	{{end}}
{{end}}

{{template "baseEnd"}}
